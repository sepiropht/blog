<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>How I Back Up My Data</title>
    <meta name="description" content="Sky above, sand below and peace within">
    <meta name="keywords" content='blog, sepiropht, hugo, aws, self-hosting, backup'>

    <meta property="og:url" content="https://sepiropht.me/posts/how-do-i-backup-my-homelab/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="How I Back Up My Data">
    <meta property="og:description" content="Sky above, sand below and peace within">
    <meta property="og:image" content="https://sepiropht.me/images/gorille-crypto.png">
    <meta property="og:image:secure_url" content="https://sepiropht.me/images/gorille-crypto.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="How I Back Up My Data">
    <meta name="twitter:description" content="Sky above, sand below and peace within">
    <meta property="twitter:domain" content="https://sepiropht.me/posts/how-do-i-backup-my-homelab/">
    <meta property="twitter:url" content="https://sepiropht.me/posts/how-do-i-backup-my-homelab/">
    <meta name="twitter:image" content="https://sepiropht.me/images/gorille-crypto.png">

    
    <link rel="canonical" href="https://sepiropht.me/posts/how-do-i-backup-my-homelab/">

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js" integrity="sha256-mpINfavbrYNjtqCpTimp3&#43;vbfuZM/LGToBReUS7yvas="></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
    <script>
      
      setThemeByUserPref()
    </script>
    <script
      async
      src="https://analytics.sepiropht.me/script.js"
      data-website-id="ae8a6792-160d-46af-afcb-435979ba069e"
    ></script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://sepiropht.me/">
                <img src='/images/gorille-crypto.png' alt="avatar">
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://sepiropht.me/">sepiropht</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://sepiropht.me/posts/"> Posts </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span class="sr-only dark-theme-toggle-screen-reader-target"></span>
                <a>
                    <span class="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://sepiropht.me/posts/"> Posts </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
                    <a>
                        <span class="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>How I Back Up My Data</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">August 22, 2024
        
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://sepiropht.me/tags/aws">aws</a></li>
        
            <li class="post-tag"><a href="https://sepiropht.me/tags/self-hosting">self-hosting</a></li>
        
            <li class="post-tag"><a href="https://sepiropht.me/tags/backup">backup</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>In my last article, I explained how Docker saved me when my Raspberry Pi, which hosted all my services, suddenly failed. Indeed, Docker allows for good compartmentalization of configurations and data, and lets you choose where to store them, which in my case was an external hard drive. In case of a failure, you just need to take the hard drive and connect it to another machine, and you&rsquo;re done.</p>
<p>These kinds of accidents happen quite often unfortunately, and the method I just described is quite effective in solving this problem.
However, what happens if it&rsquo;s the external hard drive that fails or worse, if I have a fire? In that case, do I lose everything?</p>
<p>This type of incident is rarer. I&rsquo;ve never experienced a hard drive failure. All the hard drives I bought in the previous decade are still working. So it was more difficult for me to build an infrastructure resilient to this kind of problem. I managed to do it anyway, and I&rsquo;m going to present how I proceed. I&rsquo;ll introduce you to deduplication with Borg Backup and Amazon S3 Glacier.</p>
<h2 id="1-3-2-1-rule">1. 3-2-1 Rule</h2>
<p>For setting up a backup plan, I follow this principle that seems to be a consensus of having three different copies of your data:</p>
<ul>
<li>Use at least 3 copies</li>
<li>Use two different types of media</li>
<li>And have one off-site copy</li>
</ul>
<p>The off-site copy is what allows you to survive a fire, for example.<br>
That&rsquo;s good for the overview and guiding principle, let&rsquo;s see how I apply it.</p>
<h2 id="2-borg-backup-and-deduplication">2. Borg Backup and Deduplication</h2>
<h3 id="1-install-borg-backup">1. Install Borg Backup</h3>
<p>The main problem when making backups is the redundancy of data between different backups. Fortunately, tools like Borg exist, allowing us to make incremental backups. This means, the first time it backs up all your files, but the other times it only records the changes, which saves bandwidth and also space on the backup disk.</p>
<p>If Borg Backup is not yet installed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo apt install borgbackup
</span></span></code></pre></div><h3 id="2-configure-aws-cli">2. Configure AWS CLI</h3>
<p>Configure AWS CLI with your AWS access information:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws configure
</span></span></code></pre></div><p>You will be prompted to enter the following information:</p>
<ul>
<li>AWS Access Key ID: Your AWS access key.</li>
<li>AWS Secret Access Key: Your AWS secret key.</li>
<li>Default region name: The AWS region in which your S3 bucket is located (e.g. us-west-2).</li>
<li>Default output format: You can leave this blank or choose json.</li>
</ul>
<p>Now you need to create an amazon bucket, and take care to create a glacier deep archive bucket.</p>
<p>Once you&rsquo;ve done that, you can create a</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ aws s3 sync /mnt/seagate/borg-repo s3://my-borg-backups
</span></span></code></pre></div><p>For restoration</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ aws s3 sync s3://my-borg-backups /mnt/restore-point
</span></span></code></pre></div><p>I&rsquo;ll show you the final script for the backup</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>REPOSITORY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/mnt/seagate/borg-repo”
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SOURCE=&#34;</span>/mnt/ssd/”
</span></span><span style="display:flex;"><span>BORG_S3_BACKUP_BUCKET<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bucket-name”
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">export BORG_PASSPHRASE=&#39;PASSPHRASE&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Backup to borg repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">borg create -v --stats </span>$REPOSITORY<span style="color:#e6db74">::</span><span style="color:#66d9ef">$(</span>date +%Y-%m-%d-%h<span style="color:#66d9ef">)</span><span style="color:#e6db74"> </span>$SOURCE<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Backup to s3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">aws s3 sync </span>$REPOSITORY<span style="color:#e6db74"> s3://</span>$BORG_S3_BACKUP_BUCKET<span style="color:#e6db74"> --storage-class DEEP_ARCHIVE --delete
</span></span></span></code></pre></div><p>Finally, I call my script in a cron job every day</p>
<p>If you&rsquo;ve made it this far, you now have an automated 3-2-1 backup system with deduplication and an off-site copy.</p>

        
    </div>

    <div class="prev-next">
        
    </div>

    
    
    <svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="topFunction()" title="Go to top">
        
        <path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/>
    </svg>
    <script>
        let backToTopButton = document.getElementById("btt-button");

        window.onscroll = function() {
            scrollFunction()
        };

        function scrollFunction() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                backToTopButton.style.display = "block";
            } else {
                backToTopButton.style.display = "none";
            }
        }

        function topFunction() {
            smoothScrollToTop();
        }

        function smoothScrollToTop() {
            const scrollToTop = () => {
                const c = document.documentElement.scrollTop || document.body.scrollTop;
                if (c > 0) {
                    window.requestAnimationFrame(scrollToTop);
                    window.scrollTo(0, c - c / 8);
                }
            };
            scrollToTop();
        }
    </script>
    
    
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-3-2-1-rule">1. 3-2-1 Rule</a></li>
        <li><a href="#2-borg-backup-and-deduplication">2. Borg Backup and Deduplication</a>
          <ul>
            <li><a href="#1-install-borg-backup">1. Install Borg Backup</a></li>
            <li><a href="#2-configure-aws-cli">2. Configure AWS CLI</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    
</main><footer class="footer">
    
    

    
    <span>&copy; 2024 The Marauders</span>
    
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
